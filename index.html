<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LeetCode Profile + Heatmap</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .input-box {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    input {
      padding: 10px;
      width: 250px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      padding: 10px 15px;
      border: none;
      background: #28a745;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background: #218838;
    }

    #status {
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
    }

    .profile-box {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      background: #fafafa;
      border: 1px solid #ddd;
    }

    .profile-box img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 2px solid #ccc;
    }

    .profile-details {
      flex: 1;
    }

    .profile-details h3 {
      margin: 0;
      font-size: 22px;
    }

    .profile-details p {
      margin: 5px 0;
      color: #333;
    }

    .stats-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      background: #f9f9f9;
      border: 1px solid #ddd;
    }

    .stats-box h3 {
      margin-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      text-align: center;
    }

    .stat-card {
      padding: 10px;
      background: white;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-weight: bold;
    }

    /* Heatmap section */
    .heatmap-wrapper {
      margin-top: 25px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .heatmap {
      display: grid;
      grid-template-rows: repeat(7, 12px);
      grid-auto-flow: column;
      grid-auto-columns: 12px;
      gap: 3px;
      justify-content: start;
    }

    .day {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      background: #ebedf0;
      cursor: pointer;
    }

    .level-0 { background: #ebedf0; }
    .level-1 { background: #9be9a8; }
    .level-2 { background: #40c463; }
    .level-3 { background: #30a14e; }
    .level-4 { background: #216e39; }

    .tooltip {
      position: absolute;
      background: black;
      color: white;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 6px;
      display: none;
      pointer-events: none;
      z-index: 1000;
    }

    .badges {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      background: #fafafa;
      border: 1px solid #ddd;
    }

    .badge-list {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }

    .badge-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 10px;
      background: white;
      border: 1px solid #ddd;
    }

    .badge-item img {
      width: 40px;
      height: 40px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>LeetCode Profile Viewer + Heatmap</h2>

    <div class="input-box">
      <input type="text" id="username" placeholder="Enter LeetCode Username" />
      <button onclick="fetchUserData()">Search</button>
    </div>

    <p id="status"></p>

    <div id="profileSection"></div>
    <div id="statsSection"></div>

    <div class="heatmap-wrapper">
      <h3>üìå Submission Heatmap (Correct Layout)</h3>
      <div class="heatmap" id="heatmap"></div>
    </div>

    <div id="badgesSection"></div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script>
    async function fetchUserData() {
      const username = document.getElementById("username").value.trim();
      const status = document.getElementById("status");

      document.getElementById("profileSection").innerHTML = "";
      document.getElementById("statsSection").innerHTML = "";
      document.getElementById("heatmap").innerHTML = "";
      document.getElementById("badgesSection").innerHTML = "";

      if (!username) {
        status.innerText = "‚ö† Please enter a username!";
        return;
      }

      status.innerText = "‚è≥ Fetching user data...";

      try {
        const response = await fetch(`http://localhost:3000/leetcode/${username}`);
        const data = await response.json();

        if (data.error) {
          status.innerText = "‚ùå User not found!";
          return;
        }

        status.innerText = "‚úÖ Data Loaded Successfully!";

        showProfile(data);
        showStats(data);
        generateCorrectHeatmap(data.calendar.submissionCalendar);
        showBadges(data.badges);

      } catch (error) {
        status.innerText = "‚ùå Backend not running or connection error!";
        console.log(error);
      }
    }

    function showProfile(data) {
      const profile = data.profile;

      document.getElementById("profileSection").innerHTML = `
        <div class="profile-box">
          <img src="${profile.userAvatar}" alt="Avatar" />
          <div class="profile-details">
            <h3>${profile.realName || "No Name"} (@${data.username})</h3>
            <p><b>Ranking:</b> ${profile.ranking ?? "N/A"}</p>
            <p><b>Country:</b> ${profile.countryName || "N/A"}</p>
            <p><b>School:</b> ${profile.school || "N/A"}</p>
            <p><b>Company:</b> ${profile.company || "N/A"}</p>
          </div>
        </div>
      `;
    }

    function showStats(data) {
      const stats = data.submitStats.acSubmissionNum;

      let totalSolved = 0, easy = 0, medium = 0, hard = 0;

      stats.forEach(item => {
        if (item.difficulty === "All") totalSolved = item.count;
        if (item.difficulty === "Easy") easy = item.count;
        if (item.difficulty === "Medium") medium = item.count;
        if (item.difficulty === "Hard") hard = item.count;
      });

      document.getElementById("statsSection").innerHTML = `
        <div class="stats-box">
          <h3>üìä Problem Solving Stats</h3>
          <div class="stats-grid">
            <div class="stat-card">Total Solved<br>${totalSolved}</div>
            <div class="stat-card">Easy<br>${easy}</div>
            <div class="stat-card">Medium<br>${medium}</div>
            <div class="stat-card">Hard<br>${hard}</div>
          </div>
          <p style="text-align:center; margin-top:15px; font-weight:bold;">
            üî• Streak: ${data.calendar.streak} days | Active Days: ${data.calendar.totalActiveDays}
          </p>
        </div>
      `;
    }

    function generateCorrectHeatmap(calendarData) {
      const heatmapDiv = document.getElementById("heatmap");
      const tooltip = document.getElementById("tooltip");

      heatmapDiv.innerHTML = "";

      // Find start date (1 year back)
      const today = new Date();
      const endUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
      const startUTC = new Date(endUTC);
      startUTC.setUTCDate(endUTC.getUTCDate() - 364);

      // Add empty blocks before first day (align week properly)
      const startDay = startUTC.getUTCDay(); // 0=Sun
      for (let i = 0; i < startDay; i++) {
        const emptyDiv = document.createElement("div");
        emptyDiv.classList.add("day", "level-0");
        emptyDiv.style.opacity = "0";
        heatmapDiv.appendChild(emptyDiv);
      }

      // Fill days
      for (let i = 0; i < 365; i++) {
        const date = new Date(startUTC);
        date.setUTCDate(startUTC.getUTCDate() + i);

        const timestamp = Math.floor(date.getTime() / 1000);
        const submissions = calendarData[timestamp] || 0;

        const dayDiv = document.createElement("div");
        dayDiv.classList.add("day");

        let level = 0;
        if (submissions >= 1 && submissions <= 2) level = 1;
        else if (submissions <= 5) level = 2;
        else if (submissions <= 10) level = 3;
        else if (submissions > 10) level = 4;

        dayDiv.classList.add("level-" + level);

        dayDiv.addEventListener("mousemove", (e) => {
          tooltip.style.display = "block";
          tooltip.style.left = e.pageX + 10 + "px";
          tooltip.style.top = e.pageY + 10 + "px";
          tooltip.innerHTML = `<b>${submissions} submissions</b><br>${date.toDateString()}`;
        });

        dayDiv.addEventListener("mouseleave", () => {
          tooltip.style.display = "none";
        });

        heatmapDiv.appendChild(dayDiv);
      }
    }

    function showBadges(badges) {
      if (!badges || badges.length === 0) {
        document.getElementById("badgesSection").innerHTML = `
          <div class="badges">
            <h3>üèÜ Badges</h3>
            <p>No badges found.</p>
          </div>
        `;
        return;
      }

      let badgeHTML = `
        <div class="badges">
          <h3>üèÜ Badges (${badges.length})</h3>
          <div class="badge-list">
      `;

      badges.forEach(b => {
        badgeHTML += `
          <div class="badge-item">
            <img src="${b.icon}" alt="badge" />
            <b>${b.displayName}</b>
          </div>
        `;
      });

      badgeHTML += `</div></div>`;

      document.getElementById("badgesSection").innerHTML = badgeHTML;
    }
  </script>
</body>
</html>
